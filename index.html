<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ï¥àÎ°ùÍ∑∏Î¶º ÎïåÎ¶¨Í∏∞</title>
<style>
    body {
        font-family: 'Noto Sans KR', sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: #fffaf5;
        margin: 0;
    }

    h1 {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    #cat {
        width: 220px;
        cursor: pointer;
        transition: transform 0.1s ease;
    }
    #cat:active { transform: scale(0.95); }

    .counter {
        font-size: 2.2rem;
        margin-top: 0.5rem;
        font-weight: bold;
    }

    #totalPops {
        margin-top: 1.2rem;
        font-size: 1.6rem;
        color: #444;
    }

    ul {
        list-style: none;
        padding: 0;
        margin-top: 2rem;
        width: 300px;
    }

    li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 6px 0;
        padding: 6px 10px;
        border-radius: 6px;
        background: #f7f7f7;
        overflow: hidden;
        height: 1.6em;
    }

    .num-wrapper {
        position: relative;
        height: 1.2em;
        overflow: hidden;
    }

    .num-slide {
        position: absolute;
        width: 100%;
        top: 0;
        transition: transform 0.5s ease, opacity 0.5s ease;
    }

    .slide-up {
        transform: translateY(-100%);
        opacity: 0;
    }

    .slide-in {
        transform: translateY(0);
        opacity: 1;
    }

    .rank-id { font-weight: bold; }
</style>
</head>
<body>

<h1>Ï¥àÎ°ù ÎïåÎ¶¨Í∏∞</h1>
<img id="cat" src="https://popcat.click/img/cat1.png" alt="popcat">
<div class="counter">ÎÇ¥ Ï†êÏàò: <span id="myPops">0</span></div>
<div id="totalPops">Ï†ÑÏ≤¥ Pops: 
    <span class="num-wrapper"><span id="totalPopsDisplay" class="num-slide">0</span></span>
</div>
<ul id="top10List"></ul>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyA6OwwtJNtTqujb6PW6nolYmstOj7zBqCA",
    authDomain: "drawgreen-3bc38.firebaseapp.com",
    projectId: "drawgreen-3bc38"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const catImage = document.getElementById("cat");
const myPopsDisplay = document.getElementById("myPops");
const totalPopsDisplay = document.getElementById("totalPopsDisplay");
const top10List = document.getElementById("top10List");

const closedImage = "https://popcat.click/img/cat1.png";
const openImage = "https://popcat.click/img/cat2.png";
const currentUserId = "Guest" + Math.floor(Math.random() * 9999);

let localPops = 0;
let lastSynced = 0;
let prevTotal = 0;
let prevRanks = [];

// üêæ ÌÅ¥Î¶≠ Ïãú Ï†êÏàò Ï¶ùÍ∞Ä
async function handlePop() {
    catImage.src = openImage;
    setTimeout(() => catImage.src = closedImage, 80);
    localPops++;
    myPopsDisplay.textContent = localPops.toLocaleString();

    if (localPops - lastSynced >= 10) {
        const userRef = db.collection("users").doc(currentUserId);
        await userRef.set({
            pops: firebase.firestore.FieldValue.increment(localPops - lastSynced)
        }, { merge: true });
        lastSynced = localPops;
    }
}
catImage.addEventListener("click", handlePop);

// üéûÔ∏è Ïà´Ïûê Ï†ÑÌôò Ïï†ÎãàÎ©îÏù¥ÏÖò
function updateNumberSmooth(element, newValue) {
    const oldValue = element.textContent.replace(/,/g, "");
    if (oldValue === newValue.toString()) return;

    const newEl = document.createElement("span");
    newEl.className = "num-slide";
    newEl.textContent = newValue.toLocaleString();
    newEl.style.transform = "translateY(100%)";
    newEl.style.opacity = "0";
    element.parentNode.appendChild(newEl);

    requestAnimationFrame(() => {
        element.classList.add("slide-up");
        newEl.classList.add("slide-in");
        newEl.style.transform = "translateY(0)";
        newEl.style.opacity = "1";
    });

    setTimeout(() => {
        element.parentNode.removeChild(element);
        newEl.id = element.id;
    }, 500);
}

// üèÜ ÏàúÏúÑ Í∞±Ïã†
async function updateRankingsSmooth() {
    try {
        const snapshot = await db.collection("users")
            .orderBy("pops", "desc")
            .limit(10)
            .get();

        let total = 0;
        const ranks = [];

        snapshot.docs.forEach((doc, index) => {
            const data = doc.data();
            const pops = data.pops || 0;
            total += pops;
            ranks.push({ id: doc.id, pops });
        });

        updateNumberSmooth(totalPopsDisplay, total);
        prevTotal = total;

        updateRankListSmooth(ranks);
        prevRanks = ranks;

    } catch (err) {
        console.error("Firestore ÏùΩÍ∏∞ Ïò§Î•ò:", err);
    }
}

// ÏàúÏúÑÌëú Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ÑÌôò
function updateRankListSmooth(ranks) {
    if (top10List.children.length === 0) {
        top10List.innerHTML = ranks.map((r, i) => `
            <li>
                <span class="rank-id">${i + 1}. ${r.id}</span>
                <span class="num-wrapper">
                    <span class="num-slide">${r.pops.toLocaleString()}</span>
                </span>
            </li>
        `).join('');
        return;
    }

    ranks.forEach((r, i) => {
        const li = top10List.children[i];
        if (!li) return;
        li.querySelector(".rank-id").textContent = `${i + 1}. ${r.id}`;
        const numEl = li.querySelector(".num-slide");
        updateNumberSmooth(numEl, r.pops);
    });
}

// ‚è± 5Ï¥àÎßàÎã§ FirestoreÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏
updateRankingsSmooth();
setInterval(updateRankingsSmooth, 5000);
</script>
</body>
</html>
